
@inherits WebComponentesBase 
@using AppV7.Shared
@using AppV7.Shared.Libreria

<div class="form-grup row">        
        <div class="col-sm-9">
            <div class="nav-item px-3">
                <RadzenButton Icon="add_circle_outline" style="margin-bottom: 10px" 
                Text="Nuevo Pagina" 
                Click="@InsertRow" Disabled="@Editando"/>
                <RadzenButton Icon="refresh" style="margin-bottom: 10px" ButtonStyle="ButtonStyle.Info"                 
                Click="@LoadData" />
            </div>
        </div>
        
        <div class="col-sm-3">
            <div class="nav-item px-3">
                <NavLink class="nav-link" href=@($"/")>
                <span class="oi oi-caret-left" aria-hidden="true"></span> Regresar a Inicio</NavLink>
            </div>
        </div>
    </div>

    <RadzenDataGrid @ref="WSGrid" AllowFiltering="true" AllowPaging="true" PageSize="50" 
                AllowSorting="true" AllowColumnResize="true"
                ExpandMode="DataGridExpandMode.Single" AllowGrouping="false"
                EditMode="DataGridEditMode.Single" 
                Data="@LosWS" TItem="Z800_WebSite" RowUpdate="@OnUpdateRow" 
                RowCreate="@OnCreateRow" >
                
        <Template Context="datos1">
 
            <RadzenTabs>
                <Tabs>
                    <RadzenTabsItem Text="Detalles ">
                        Uno 
                    </RadzenTabsItem>
                    <RadzenTabsItem Text="Extras">
                        <RadzenDataList WrapItems="true" AllowPaging="true" Data="@LosWS" 
                            TItem="Z800_WebSite" PageSize="10">
                            <Template Context="datos2">
                                <RadzenCard Style="width:100px; height:100px">
                                    <h4 class="text-thin">Organizacion</h4>
                                    <b>@datos2.Catalogo</b>
                                </RadzenCard>
                            </Template>
                        </RadzenDataList>
                    </RadzenTabsItem>
                </Tabs>
            </RadzenTabs>
        </Template>
<!-- AQUI EMPIEZA REPORTE-->
        
        <Columns>

            <RadzenDataGridColumn TItem="Z800_WebSite" Property="Catalogo" Title="Catalogo" Filterable="true"  
                Width="150px">
                <Template Context="datos">
                    @datos.Catalogo 
                </Template>
                <EditTemplate Context="datos">
                    <RadzenDropDown Name="Catalogo" Data=@LosCats @bind-Value=@datos.Catalogo
                        ValueProperty="Catalogo" TextProperty="Titulo"
                        AllowClear="true" Style="width: 300px;" />
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="Z800_WebSite" Property="Indice" Title="Indice" Filterable="false"  
                Width="70px">
                <Template Context="datos">
                    @datos.Indice
                </Template>
                <EditTemplate Context="datos">
                    <RadzenNumeric Name="Indice" @bind-Value="datos.Indice" ShowUpDown="false"   
                        Min="1" Max="25" Style="width: 90%" />
                    
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="Z800_WebSite" Property="Titulo" Title="Titulo" Filterable="false"  
                Width="200px">
                <Template Context="datos">
                    @datos.Titulo
                </Template>
                <EditTemplate Context="datos">
                    <RadzenTextBox Name="Titulo" @bind-Value="datos.Titulo" Style="width: 90%" /> <br>
                    <RadzenLengthValidator Component="Titulo" Min="1" Max="35" 
                        Text="El Titulo del Componente es de 1 digitos y  hasta 35!" />
                </EditTemplate>
            </RadzenDataGridColumn>
 
            <RadzenDataGridColumn TItem="Z800_WebSite" Property="Valor" Title="Valor" 
                Filterable="false"  Width="170px">
                <Template Context="datos">
                    @datos.Valor
                </Template>
                <EditTemplate Context="datos">
                    <RadzenTextBox Name="Valor" @bind-Value="datos.Valor" Style="width: 90%" /> <br>
                    <RadzenTextBox Name="TipoValor" @bind-Value="datos.TipoValor" Style="width: 90%" 
                    Placeholder="Numero, Texto, usa 1 para verdad"/> <br>
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="Z800_WebSite" Property="Componente" Title="Componente" Filterable="false"  
                Width="200px">
                <Template Context="datos">
                    @datos.Componente
                </Template>
                <EditTemplate Context="datos">
                    <RadzenDropDown Name="Componente" Data=@LosComp AllowClear="true" 
                        Style="width: 300px;" @bind-Value=@datos.Componente 
                        ValueProperty="Key" TextProperty="Value" />
                </EditTemplate>
            </RadzenDataGridColumn>


            <RadzenDataGridColumn TItem="Z800_WebSite" Property="Fecha" Title="Fecha" Filterable="true"  
                Width="130px">
                <Template Context="Data">
                    <label>@($"{@MyFunc.FormatoFecha("DD/MMM/AA",Data.Fecha)}")</label>
                    
                </Template>
                <EditTemplate Context="datos">
                    <RadzenDatePicker TValue="DateTime" ShowTime="false" ShowSeconds="false" 
                        HoursStep="1.5" MinutesStep="5" DateFormat="MM/dd/yyyy HH:mm" Class="w-100" />
                </EditTemplate>
            </RadzenDataGridColumn>
        
            <RadzenDataGridColumn TItem="Z800_WebSite" Property="Nivel" Title="Nivel" Filterable="false"  
                Width="70px">
                <Template Context="datos">
                    @datos.Nivel
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="Z800_WebSite" Context="sampleBlazorModelsSampleOrder" 
                    Filterable="false" Sortable="false" TextAlign="TextAlign.Center" 
                    Width="250px" Title="Estado">
                <Template Context="datos">
                    @if (datos.Estado == 1)
                    {
                        <label>Mostrar</label>
                    }
                    else
                    {
                        <label>Ocultar</label>
                    }
                    <br />
                    @if (datos.Titulo != "Raiz")
                    {
                        <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Secondary" 
                            Class="m-1" Click="@((args) => EditRow(datos))" Visible="@(!Editando)" >
                        </RadzenButton>
                    }
                    @if(datos.Status)
                    { 
                        <b>Activo</b>
                    }
                    else
                    {
                        <b>Suspendido</b>
                    }
                    <br />
                </Template>

                <EditTemplate Context="datos">
                @if (datos.Estado != 3)
                {
                    <RadzenSelectBar @bind-Value=@datos.Estado >
                        <Items>
                            <RadzenSelectBarItem Text="Mostrar" Value="1" />
                            <RadzenSelectBarItem Text="Ocultar" Value="2" />
                        </Items>
                    </RadzenSelectBar>
                    <br />
                }
                
                @if (datos.Estado != 3)
                {    
                    <label>Borrar este registro? Si </label>
                    <RadzenSwitch @bind-Value=@datos.Status Name="Status" /> 
                    <label>No!</label>
                    <br />
                }

                @if (datos.Titulo != "Raiz")
                {
                    <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Primary" 
                            Class="m-1" Click="@((args) => SaveRow(datos))">
                    </RadzenButton>
                }   
                <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Class="m-1" 
                    Click="@((args) => CancelEdit(datos))" />
                        
                </EditTemplate>

            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
@code {

    Z800_WebSite WSToInsert = new();


    async Task EditRow(Z800_WebSite webS)
    {
        await WSGrid.EditRow(webS);
        Editando = !Editando;
    }
    async void OnUpdateRow(Z800_WebSite webS)
    {
        if (webS == WSToInsert) WSToInsert = null!;
        webS.Titulo = webS.Titulo.ToUpper();

        await WebSiteIServ.UpdateWebSite(webS);
        Editando = !Editando;
        
        string texto = $"Se actualizo un registro del website {webS.Titulo}";
        texto += $" Catalogo={webS.Catalogo}, indice={webS.Indice}, valor= {webS.Valor}, mostrar=";
        texto += webS.Estado == 1 ? "No" : "Si";
        texto += webS.Status ? "" : "Borro el registro!!";
        await Escribir(ElUsuario.UsuariosId, ElUsuario.OrgId, texto, false);
        await LoadData();
    }
    async Task SaveRow(Z800_WebSite webS)
    {
        webS.Titulo = webS.Titulo.ToUpper();
        @if (webS.Titulo == "RAIZ") webS.Titulo += "1";
        await WSGrid.UpdateRow(webS);
        
    }
    void CancelEdit(Z800_WebSite webS)
    {
        if (webS == WSToInsert) WSToInsert = null!;
        Editando = !Editando; 
        WSGrid.CancelEditRow(webS);
    }
    async Task InsertRow()
    {
        WSToInsert = new Z800_WebSite();
        WSToInsert.Id = Guid.NewGuid().ToString();
        WSToInsert.Indice = 1;
        WSToInsert.Estado = 3;
        Editando = !Editando;

        await WSGrid.InsertRow(WSToInsert); 

    }
    async void OnCreateRow(Z800_WebSite webS)
    {
        if (webS == WSToInsert) WSToInsert = null;

        webS.Catalogo = SigCat(webS.Catalogo, 
            int.Parse(DatosDic[$"CatNiv_{webS.Catalogo}"]) );
        webS.Nivel = int.Parse(DatosDic[$"CatNiv_{webS.Catalogo}"]);

        webS.Titulo = webS.Titulo.ToUpper();
        webS.Estado = 1;
        webS.Status = true;


        Z800_WebSite resultado = new Z800_WebSite();
        Editando = !Editando;
        resultado = await WebSiteIServ.AddWebSite(webS);

        await LoadData();


        string texto = $"Se IVAN creo un registro de los componentes {webS.Titulo}";
        texto += $" Catalog={webS.Catalogo}, indice={webS.Indice}, valor={webS.Valor} desde sistema";
        await Escribir(ElUsuario.UsuariosId, ElUsuario.OrgId, texto, false);


    }

    public void ShowNotification(NotificationMessage message)
    {
        //NS.Notify(message);
    }

    async Task LoadData()
    {
        await LeerWebSite();
        Editando = false;
        await WSGrid.Reload();
        //LosWS = await WebSiteIServ.Buscar("All");
    }
}
