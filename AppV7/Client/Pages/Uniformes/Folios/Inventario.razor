@page "/inventarios"
@inherits InventarioBase
@using AppV7.Shared


@if (Datos)
{
    <RadzenCard>
        <RadzenTemplateForm @ref=FiltroTemp Data="@ElFiltro"
                        TItem="@Filtro" Submit="@Filtrar">
            <div class="form-grup row">
                <label for="almacenF" class="col-sm-4 col-form-label">Almacen</label>
                <label for="almacenF" class="col-sm-4 col-form-label">Almacen</label>
                <label for="almacenF" class="col-sm-4 col-form-label">Almacen</label>
            </div>
            <div class="form-grup row">
                <div class="col-sm-4">
                    <RadzenDropDown Name="AlmacenF" Data=@LosAlmacenes @bind-Value=@ElFiltro.AlmacenF
                                ValueProperty="AlmacenId" TextProperty="Corto" 
                                AllowClear="true" Style="width: 300px;" />
                </div>
                <div class="col-sm-4">
                    <RadzenDropDown Name="ComercioF" Data=@LosUsers @bind-Value=@ElFiltro.ComercioF
                                ValueProperty="AlmacenId" TextProperty="Corto" AllowClear="true" Style="width: 300px;" />
                </div>
                <div class="col-sm-4">
                    <RadzenDropDown Name="Tipos" Data=@LosTipos @bind-Value=@ElFiltro.TipoF
                                ValueProperty="AlmacenId" TextProperty="Corto" AllowClear="true" Style="width: 300px;" />
                </div>
            </div>
            <div class="form-grup row">
                <label for="almacenF" class="col-sm-4 col-form-label"></label>
                <label for="almacenF" class="col-sm-4 col-form-label"></label>
                <div class="col-sm-4">
                    <RadzenButton ButtonType="ButtonType.Submit" Text="Registro" />
                </div>
            </div>

        </RadzenTemplateForm>
    </RadzenCard>

    <RadzenCard>
        <RadzenDataGrid @ref="SolGrid" Data="@LasSolicitudes" TItem="Z230_Solicitud" PageSize="50"
            AllowFiltering="true" AllowPaging="true" AllowSorting="true" AllowColumnResize="true"
            AllowGrouping="true" Render="@OnRender" GroupRowRender="OnGroupRowRender">
            <Columns>
                <RadzenDataGridColumn Width="80px" TItem="Z230_Solicitud" Title="#" 
                    Filterable="false" Sortable="false" TextAlign="TextAlign.Center">
                    <Template>
                        @(LasSolicitudes.IndexOf(context) + 1)
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Z230_Solicitud" Property="Almacen" 
                    Title="Almacen" Filterable="true" Width="150px">
                    <Template Context="datos">
                        @datos.Almacen
                    </Template>
                    <FooterTemplate>
                        Totales: <b>@SolGrid.View.Count()</b> de <b>@LasSolicitudes.Count()</b>
                    </FooterTemplate>

                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Z230_Solicitud" Property="Usuario"
                                  Title="Afiliado" Filterable="true" Width="150px">
                    <Template Context="datos">
                        @LosUsers.FirstOrDefault(x=> x.UsuariosId==datos.Usuario).OldEmail
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Z230_Solicitud" Property="Tipo"
                                  Title="Grupo" Filterable="true" Width="150px">
                    <Template Context="datos">
                        @datos.Tipo
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Z230_Solicitud" Property="Producto"
                                  Title="Producto" Filterable="true" Width="150px">
                    <Template Context="datos">
                         @LosDet.FirstOrDefault(x=>x.SolicitudId==datos.SolicitudId).Producto
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Z230_Solicitud" Property="Cantidad"
                                  Title="Cantidad" Filterable="true" Width="150px">
                    <Template Context="datos">
                        @LosDet.FirstOrDefault(x=>x.SolicitudId==datos.SolicitudId).Cantidad
                    </Template>
                </RadzenDataGridColumn>

            </Columns>

        </RadzenDataGrid>

    </RadzenCard>

}
else

{
    <div class="spinner"></div>
}



@code {
    
    bool? groupsExpanded;
    async Task Filtrar()
    {
        ElFiltro.Filtrado = true;
        await LeerSolicitudes(ElFiltro.AlmacenF, ElFiltro.ComercioF, ElFiltro.TipoF);
    }
    void OnRender(DataGridRenderEventArgs<Z230_Solicitud> args)
    {
        if (args.FirstRender)
        {
            args.Grid.Groups.Add(new GroupDescriptor() { Title = "Customer", Property = "Customer.CompanyName", SortOrder = SortOrder.Descending });
            StateHasChanged();
        }
    }

    void OnGroupRowRender(GroupRowRenderEventArgs args)
    {
        args.Expanded = groupsExpanded;
    }
    
}
