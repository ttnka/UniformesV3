@page "/inventarios"
@inherits InventarioBase
@using AppV7.Shared


@if (Datos)
{
    <RadzenCard>
        <RadzenTemplateForm @ref=FiltroTemp Data="@ElFiltro"
                        TItem="@Filtro" Submit="@Filtrar">
            <div class="form-grup row">
                <label for="FolioF" class="col-sm-3 col-form-label">Folio</label>
                <label for="EstadoF" class="col-sm-3 col-form-label">Estado Folio</label>
                <label for="AlmacenF" class="col-sm-3 col-form-label">Almacen</label>
                <label for="TipoEntradaF" class="col-sm-3 col-form-label">Tipo</label>
            </div>
            <div class="form-grup row">
                <div class="col-sm-3">
                    <RadzenTextBox Name="FolioF" @bind-Value=@ElFiltro.FolioF Style="width: 100%;" />
                </div>
                <div class="col-sm-3">
                    <RadzenDropDown Name="EstadoF" Data=@LosEdos @bind-Value=@ElFiltro.EstadoF
                                ValueProperty="Value" TextProperty="Text" 
                                AllowClear="true" Style="width: 100%;" />
                </div>
                <div class="col-sm-3">
                    <RadzenDropDown Name="AlmacenF" Data=@LosAlmacenes @bind-Value=@ElFiltro.AlmacenF
                                ValueProperty="AlmacenId" TextProperty="Corto" 
                                AllowClear="true" Style="width: 100%;" />
                </div>
                <div class="col-sm-3">
                    <RadzenDropDown Name="TipoEntradaF" Data=@LosTipos @bind-Value=@ElFiltro.TipoEntradaF
                                ValueProperty="Value" TextProperty="Text" 
                                AllowClear="true" Style="width: 100%;" />
                </div>
            </div>
            <div class="form-grup row">
                <label for="ComercioF" class="col-sm-3 col-form-label">Comercio</label>
                <label for="ProductoF" class="col-sm-3 col-form-label">Producto</label>
                <label for="CiudadF" class="col-sm-3 col-form-label">Ciudad</label>
                <label for="CantidadF" class="col-sm-3 col-form-label">Cantidad</label>
            </div>
            <div class="form-grup row">
                <div class="col-sm-3">
                    <RadzenDropDown Name="ComercioF" Data=@LosUsers @bind-Value=@ElFiltro.ComercioF
                                ValueProperty="UsuarioId" TextProperty="OldEmail" 
                                AllowClear="true" Style="width: 100%;" />
                </div>
                <div class="col-sm-3">
                    <RadzenDropDown Name="ProductoF" Data=@LosProductos @bind-Value=@ElFiltro.ProductoF
                                ValueProperty="ProductoId" TextProperty="Corto" AllowClear="true" 
                                Style="width: 100%;" />
                </div>
                <div class="col-sm-3">
                    <RadzenDropDown Name="CiudadF" Data=@LosMpios @bind-Value=@ElFiltro.CiudadF
                                ValueProperty="Value" TextProperty="Text" AllowClear="true" 
                                Style="width: 100%;" />
                </div>
                <div class="col-sm-3">
                    <RadzenNumeric Name="CantidadF" @bind-Value=@ElFiltro.CantidadF 
                            ShowUpDown="false" Style="width: 100%;" />
                </div>
            </div>
            <div class="form-grup row">
                <label for="almacenF" class="col-sm-3 col-form-label"></label>
                <label for="almacenF" class="col-sm-3 col-form-label"></label>
                <label for="almacenF" class="col-sm-3 col-form-label"></label>
                <div class="col-sm-3">
                    <RadzenButton ButtonType="ButtonType.Submit" Text="Filtrar" />
                </div>
            </div>

        </RadzenTemplateForm>
    </RadzenCard>

    <RadzenCard>
        <RadzenDataGrid @ref="RepDetGrid" Data="@ElRepDet" TItem="ReporteDet" PageSize="50"
            AllowFiltering="true" AllowPaging="true" AllowSorting="true" AllowColumnResize="true"
            AllowGrouping="false" >
            <Columns>
                <RadzenDataGridColumn Width="40px" TItem="ReporteDet" Title="#" 
                    Filterable="false" Sortable="false" TextAlign="TextAlign.Center">
                    <Template>
                        @(ElRepDet.IndexOf(context) + 1)
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="ReporteDet" Title="Almacen" Property="AlmacenRt"
                                Filterable="true" Width="150px">
                    <Template Context="datos">
                        @datos.AlmacenRt
                    </Template>
                    <FooterTemplate>
                        Totales: <b>@RepDetGrid.View.Count()</b> de <b>@ElRepDet.Count()</b>
                    </FooterTemplate>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="ReporteDet" Title="Comercios" Filterable="true" 
                                Width="150px">
                    <Template Context="datos">
                        @datos.ComercioRt
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="ReporteDet" Title="Grupo" Filterable="true" 
                                Width="150px">
                    <Template Context="datos">
                        @datos.TipoEntradaRt    
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="ReporteDet" Title="Producto" Filterable="true" 
                                Width="150px">
                    <Template Context="datos">
                         @datos.ProductoRt
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="ReporteDet" Title="Entradas" Filterable="true" 
                                  Width="100px" TextAlign="TextAlign.Right" >
                    <Template Context="datos">
                        @if(datos.TipoEntradaRt != "Solicitud") {
                            <label>@String.Format(new System.Globalization.CultureInfo("en-US"), 
                                "{0:C}", @datos.CantidadRt)
                            </label>
                        } else
                        {
                            <label>0</label>
                        }
                    </Template>
                    <FooterTemplate>
                        <label>
                            @String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C}",
                            ElRepDet.Where(o => o.TipoEntradaRt != "Solicitud").
                            Sum(o => o.CantidadRt))
                        </label>
                    </FooterTemplate>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="ReporteDet" Title="Salidas" Filterable="true"
                                  Width="100px" TextAlign="TextAlign.Right">
                    <Template Context="datos">
                        @if (datos.TipoEntradaRt == "Solicitud")
                        {
                            <label>
                                @String.Format(new System.Globalization.CultureInfo("en-US"), 
                                "{0:C}", @datos.CantidadRt)
                            </label>
                        }
                        else
                        {
                            <label>0</label>
                        }
                    </Template>
                    <FooterTemplate>
                        <label>
                                @String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C}", 
                                ElRepDet.Where(o => o.TipoEntradaRt == "Solicitud").
                                Sum(o => o.CantidadRt))
                        </label>
                    </FooterTemplate>
                </RadzenDataGridColumn>
            </Columns>

        </RadzenDataGrid>

    </RadzenCard>

}
else

{
    <div class="spinner"></div>
}



@code {

    bool? groupsExpanded;
    async Task Filtrar()
    {
        ElFiltro.Filtrado = true;
        await LeerRegistros();
    }
    void OnRender(DataGridRenderEventArgs<ReporteDet> args)
    {
        if (args.FirstRender)
        {
           // args.Grid.Groups.Add(new GroupDescriptor() { Title = "Almacen", Property = "ReporteDet.AlmacenRt", SortOrder = SortOrder.Descending });
           // StateHasChanged();
        }
    }

    void OnGroupRowRender(GroupRowRenderEventArgs args)
    {
        //args.Expanded = groupsExpanded;
    }
    
    /*
      Render="@OnRender" GroupRowRender="OnGroupRowRender"
    
    
    */
}
